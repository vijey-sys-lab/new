<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Devverse — No-skip Video (Day 1–20)</title>

  <!-- Inline favicon (simple D circle) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><circle cx='64' cy='64' r='64' fill='%2300b894'/><text x='64' y='78' font-size='64' font-family='Arial' font-weight='700' text-anchor='middle' fill='white'>D</text></svg>">

  <style>
    :root{
      --bg:#f3f7fb; --card:#fff; --accent:#00b894; --muted:#667085; --danger:#ff6b6b;
      --radius:12px; --shadow: 0 10px 30px rgba(13,38,59,0.06);
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial; background:var(--bg); margin:0; color:#0b1220}
    .wrap{max-width:980px;margin:30px auto;padding:20px;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);animation:fadeIn .45s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    header{display:flex;align-items:center;gap:12px}
    .logo{display:flex;align-items:center;gap:10px}
    .logo svg{width:48px;height:48px}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .grid2{display:grid;grid-template-columns:1fr 320px;gap:16px;margin-top:14px}
    label{font-size:13px;color:#0b1220;display:block;margin-bottom:6px}
    input,select,button{font-size:14px;padding:10px;border-radius:10px;border:1px solid #e6edf5;background:#fff}
    input:focus,select:focus,button:focus{outline:2px solid rgba(0,184,148,0.12)}
    .controls{display:flex;gap:10px;align-items:center}
    .player{margin-top:18px;background:#000;border-radius:10px;overflow:hidden;position:relative}
    video{width:100%;height:520px;background:#000;display:block;outline:none}
    .note{font-size:13px;color:var(--muted);margin-top:10px}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px;color:var(--muted)}
    .btn{cursor:pointer;border:none;background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;transition:transform .12s ease, box-shadow .12s}
    .btn:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,184,148,0.18)}
    .btn.secondary{background:#f1f5f9;color:#0b1220;border:1px solid #e6edf5}
    .btn.warn{background:var(--danger)}
    .top-right{display:flex;gap:8px;align-items:center}
    .tokenBox{margin-top:16px;padding:12px;border-radius:10px;background:#ecfdf5;border:1px solid #c6f6d5}
    .adminPanel{margin-top:12px;padding:12px;border-radius:10px;background:#0b122015;border:1px solid rgba(11,17,32,0.04)}
    .fileInfo{font-size:13px;color:var(--muted)}
    footer{margin-top:18px;font-size:13px;color:var(--muted)}
    @media (max-width:880px){
      .grid2{grid-template-columns:1fr}
      video{height:360px}
    }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div class="logo" aria-hidden>
        <!-- Logo -->
        <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
          <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#00b894"/><stop offset="1" stop-color="#0077ff"/></linearGradient></defs>
          <rect width="48" height="48" rx="10" fill="url(#g)"/>
          <text x="24" y="30" font-size="20" font-family="Segoe UI, Arial" font-weight="700" fill="#fff" text-anchor="middle">D</text>
        </svg>
      </div>
      <div>
        <h1>Devverse — No-skip Video (Day 1–20)</h1>
        <p class="lead">Students must enter name & email. Forward skipping blocked. Completion token generated on finish.</p>
      </div>
      <div style="margin-left:auto" class="top-right">
        <button id="adminToggle" class="btn secondary">Admin</button>
      </div>
    </header>

    <div class="grid2">
      <!-- left: controls & player -->
      <div>
        <div style="display:flex;gap:10px;align-items:end">
          <div style="flex:1">
            <label for="name">Full name</label>
            <input id="name" placeholder="Your full name" />
          </div>
          <div style="width:240px">
            <label for="email">Email</label>
            <input id="email" placeholder="you@gmail.com" />
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
          <div>
            <label for="day">Select Day</label>
            <select id="day"></select>
          </div>

          <div style="margin-left:auto" class="controls">
            <button id="playBtn" class="btn">Play</button>
            <button id="pauseBtn" class="btn secondary">Pause</button>
            <button id="fsBtn" class="btn secondary" title="Fullscreen">⤢ Fullscreen</button>
          </div>
        </div>

        <div class="player" id="playerWrap">
          <video id="video" playsinline></video>
        </div>

        <div class="note">Skipping forward is blocked. You may pause. If you try to jump ahead the player will snap back.</div>
        <div id="error" class="muted" style="margin-top:10px"></div>

        <div id="tokenArea"></div>
      </div>

      <!-- right: admin -->
      <aside>
        <div class="adminPanel" id="adminPanel" style="display:none">
          <label for="uploadDay">Upload / Replace Day (stores in this browser)</label>
          <select id="uploadDay"></select>

          <label style="margin-top:10px">Select video file</label>
          <input id="videoFile" type="file" accept="video/*" />

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="uploadBtn" class="btn">Upload to Browser</button>
            <button id="clearLocalBtn" class="btn secondary">Remove Local Video</button>
          </div>

          <div class="fileInfo" style="margin-top:10px">Local video: <span id="localInfo">— none —</span></div>

          <hr style="margin:12px 0">

          <div style="display:flex;gap:8px">
            <button id="exportTokens" class="btn">Export tokens CSV</button>
            <button id="wipeTokens" class="btn warn">Clear tokens</button>
          </div>

          <p class="small" style="margin-top:10px">Admin access requires a passphrase. Change it in the script if needed.</p>
        </div>
      </aside>
    </div>

    <footer>Deploy on GitHub Pages. Videos are hosted on Archive.org (paste URLs into the config).</footer>
  </div>

<script>
/*
  FINAL index.html for GitHub Pages + Archive.org video hosting
  ----------------------------------------------------------
  Steps after downloading this file:
  1. Upload each day video to Archive.org and copy its direct mp4 URL.
  2. Replace the 'REPLACE_WITH_ARCHIVE_URL_DAYX' strings in ARCHIVE_URLS below with your archive.org URLs.
  3. Save & deploy this file on GitHub Pages (index.html at repo root).
*/

const ADMIN_PASSPHRASE = 'devverse-admin-2025'; // change before sharing
const DAY_COUNT = 20;
const SEEK_TOLERANCE = 0.5; // seconds tolerance for small jumps
const HEARTBEAT_MS = 7000;  // progress save interval

// ---------- Replace these placeholders with your actual archive.org mp4 URLs ----------
const ARCHIVE_URLS = {
  1: 'https://archive.org/download/day1_20251205/day1.mp4',
  2: 'REPLACE_WITH_ARCHIVE_URL_DAY2',
  3: 'REPLACE_WITH_ARCHIVE_URL_DAY3',
  4: 'REPLACE_WITH_ARCHIVE_URL_DAY4',
  5: 'REPLACE_WITH_ARCHIVE_URL_DAY5',
  6: 'REPLACE_WITH_ARCHIVE_URL_DAY6',
  7: 'REPLACE_WITH_ARCHIVE_URL_DAY7',
  8: 'REPLACE_WITH_ARCHIVE_URL_DAY8',
  9: 'REPLACE_WITH_ARCHIVE_URL_DAY9',
 10: 'REPLACE_WITH_ARCHIVE_URL_DAY10',
 11: 'REPLACE_WITH_ARCHIVE_URL_DAY11',
 12: 'REPLACE_WITH_ARCHIVE_URL_DAY12',
 13: 'REPLACE_WITH_ARCHIVE_URL_DAY13',
 14: 'REPLACE_WITH_ARCHIVE_URL_DAY14',
 15: 'REPLACE_WITH_ARCHIVE_URL_DAY15',
 16: 'REPLACE_WITH_ARCHIVE_URL_DAY16',
 17: 'REPLACE_WITH_ARCHIVE_URL_DAY17',
 18: 'REPLACE_WITH_ARCHIVE_URL_DAY18',
 19: 'REPLACE_WITH_ARCHIVE_URL_DAY19',
 20: 'REPLACE_WITH_ARCHIVE_URL_DAY20'
};
// fallback local path (optional)
const LOCAL_VIDEO_BASE = './videos';

// ---------- DOM refs ----------
const daySelect = document.getElementById('day');
const uploadDay = document.getElementById('uploadDay');
const video = document.getElementById('video');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const fsBtn = document.getElementById('fsBtn');
const nameEl = document.getElementById('name');
const emailEl = document.getElementById('email');
const errorEl = document.getElementById('error');
const tokenArea = document.getElementById('tokenArea');

const adminToggle = document.getElementById('adminToggle');
const adminPanel = document.getElementById('adminPanel');
const videoFileInput = document.getElementById('videoFile');
const uploadBtn = document.getElementById('uploadBtn');
const clearLocalBtn = document.getElementById('clearLocalBtn');
const localInfo = document.getElementById('localInfo');
const exportTokensBtn = document.getElementById('exportTokens');
const wipeTokensBtn = document.getElementById('wipeTokens');

let lastAllowed = 0;
let heartbeatTimer = null;
let sessionId = generateSessionId();
const progressKey = 'devv_progress_v1';
const tokensKey = 'devv_tokens_v1';

/* ---------- populate day selects ---------- */
for (let i = 1; i <= DAY_COUNT; i++) {
  const o = document.createElement('option'); o.value = i; o.textContent = 'Day ' + i;
  daySelect.appendChild(o);
  uploadDay.appendChild(o.cloneNode(true));
}
daySelect.value = 1;
uploadDay.value = 1;

/* ---------- IndexedDB helpers ---------- */
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open('devv_videos_db',1);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains('videos')) db.createObjectStore('videos',{keyPath:'day'});
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
async function idbPutVideo(day, blob, filename){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction('videos','readwrite'); tx.objectStore('videos').put({day, blob, filename, uploadedAt: Date.now()});
    tx.oncomplete = ()=> res(true); tx.onerror = ()=> rej(tx.error);
  });
}
async function idbGetVideo(day){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction('videos','readonly');
    const req = tx.objectStore('videos').get(day);
    req.onsuccess = ()=> res(req.result || null);
    req.onerror = ()=> rej(req.error);
  });
}
async function idbDeleteVideo(day){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction('videos','readwrite'); tx.objectStore('videos').delete(day);
    tx.oncomplete = ()=> res(true); tx.onerror = ()=> rej(tx.error);
  });
}

/* ---------- load day (prefers archive.org mapping, then local IndexedDB, then ./videos/) ---------- */
async function dayToUrl(day){
  // prefer archive.org mapping if provided (not placeholder)
  const mapped = ARCHIVE_URLS[day];
  if (mapped && !mapped.startsWith('REPLACE_WITH_ARCHIVE_URL')) return mapped;
  // check local indexedDB
  try{
    const rec = await idbGetVideo(day);
    if(rec && rec.blob){
      return URL.createObjectURL(rec.blob);
    }
  }catch(e){}
  // fallback to local /videos/dayX.mp4 if present on host
  return `${LOCAL_VIDEO_BASE}/day${day}.mp4`;
}

async function loadSelectedDay(){
  clearTokenUI();
  removeError();
  lastAllowed = 0;
  sessionId = generateSessionId();
  const day = Number(daySelect.value);
  const src = await dayToUrl(day);
  video.pause();
  video.src = src;
  video.load();
}
daySelect.addEventListener('change', loadSelectedDay);
loadSelectedDay();

/* ---------- prevent skipping behaviour ---------- */
video.controls = false;
video.addEventListener('contextmenu', e => e.preventDefault());
window.addEventListener('keydown', (e) => {
  if(['ArrowRight','ArrowLeft','Home','End','PageUp','PageDown',' '].includes(e.key)) e.preventDefault();
});

video.addEventListener('timeupdate', () => {
  if (video.currentTime > lastAllowed + 0.01) lastAllowed = video.currentTime;
});
video.addEventListener('seeking', () => {
  const desired = video.currentTime;
  if (desired > lastAllowed + SEEK_TOLERANCE) {
    // snap back
    requestAnimationFrame(() => { video.currentTime = lastAllowed; });
  }
});
setInterval(() => {
  if (video && !video.paused) {
    if (video.currentTime > lastAllowed + 1.0 + SEEK_TOLERANCE) video.currentTime = lastAllowed;
  }
}, 1000);
video.addEventListener('mousedown', e => e.preventDefault());

/* ---------- play / pause / fullscreen ---------- */
playBtn.addEventListener('click', () => {
  clearError();
  const nm = nameEl.value.trim();
  const em = emailEl.value.trim();
  if (!nm) { showError('Please enter your full name.'); return; }
  if (!validateEmail(em)) { showError('Please enter a valid email.'); return; }
  if (!video.src) { showError('No video loaded.'); return; }

  video.play().then(()=> startHeartbeat()).catch(err => showError('Playback blocked by browser: ' + (err && err.message)));
});
pauseBtn.addEventListener('click', () => { video.pause(); stopHeartbeat(); });
fsBtn.addEventListener('click', () => {
  const wrap = document.getElementById('playerWrap');
  if (wrap.requestFullscreen) wrap.requestFullscreen();
  else if (wrap.webkitRequestFullscreen) wrap.webkitRequestFullscreen();
  else if (wrap.msRequestFullscreen) wrap.msRequestFullscreen();
});

/* ---------- heartbeat (local proof) ---------- */
function startHeartbeat(){
  sendProgressOnce();
  if (heartbeatTimer) clearInterval(heartbeatTimer);
  heartbeatTimer = setInterval(sendProgressOnce, HEARTBEAT_MS);
}
function stopHeartbeat(){ if (heartbeatTimer) clearInterval(heartbeatTimer); heartbeatTimer = null; }
function sendProgressOnce(){
  try{
    const arr = JSON.parse(localStorage.getItem(progressKey) || '[]');
    arr.push({sessionId, name: nameEl.value.trim(), email: emailEl.value.trim(), day: Number(daySelect.value), currentTime: video.currentTime, updatedAt: Date.now(), duration: isFinite(video.duration) ? video.duration : null});
    localStorage.setItem(progressKey, JSON.stringify(arr));
  }catch(e){}
}

/* ---------- token on ended ---------- */
video.addEventListener('ended', () => {
  stopHeartbeat();
  generateToken();
});

/* ---------- generate token & store locally ---------- */
function generateToken(){
  const now = new Date();
  const rand = Math.random().toString(36).slice(2,10).toUpperCase();
  const token = 'DEVV-' + now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0') + '-' + rand;
  const info = { token, name: nameEl.value.trim(), email: emailEl.value.trim(), day: Number(daySelect.value), date: now.toLocaleDateString(), time: now.toLocaleTimeString(), ts: now.toISOString() };
  try{
    const arr = JSON.parse(localStorage.getItem(tokensKey) || '[]'); arr.push(info); localStorage.setItem(tokensKey, JSON.stringify(arr));
  }catch(e){}
  showTokenUI(info);
}

/* ---------- token UI ---------- */
function showTokenUI(info){
  tokenArea.innerHTML = '';
  const box = document.createElement('div'); box.className = 'tokenBox';
  box.innerHTML = `
    <div><strong>Completion token</strong></div>
    <div style="margin-top:8px">Name: ${escapeHtml(info.name)}</div>
    <div>Email: ${escapeHtml(info.email)}</div>
    <div>Day: ${info.day}</div>
    <div>Token: <strong>${info.token}</strong></div>
    <div>Date & Time: ${info.date} ${info.time}</div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="downloadToken" class="btn">Download Receipt</button>
      <button id="copyToken" class="btn secondary">Copy</button>
      <button id="viewLocalHistory" class="btn secondary">View Local Tokens</button>
    </div>
  `;
  tokenArea.appendChild(box);

  document.getElementById('downloadToken').addEventListener('click', ()=> {
    const txt = `Name: ${info.name}\nEmail: ${info.email}\nDay: ${info.day}\nToken: ${info.token}\nDate: ${info.date}\nTime: ${info.time}\n`;
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([txt], {type:'text/plain'})); a.download = 'token_' + info.token + '.txt'; a.click(); URL.revokeObjectURL(a.href);
  });
  document.getElementById('copyToken').addEventListener('click', ()=> { const txt = `Name: ${info.name}\nEmail: ${info.email}\nDay: ${info.day}\nToken: ${info.token}\nDate: ${info.date}\nTime: ${info.time}\n`; navigator.clipboard.writeText(txt).then(()=> alert('Copied token to clipboard.')); });
  document.getElementById('viewLocalHistory').addEventListener('click', ()=> { const arr = JSON.parse(localStorage.getItem(tokensKey) || '[]'); alert('Stored tokens (localStorage):\n' + JSON.stringify(arr, null, 2)); });
}
function clearTokenUI(){ tokenArea.innerHTML = ''; }

/* ---------- admin panel (client-side passphrase) ---------- */
adminToggle.addEventListener('click', async () => {
  if (adminPanel.style.display === 'none' || adminPanel.style.display === '') {
    const pass = prompt('Enter Admin Passphrase:');
    if (!pass) return;
    if (pass !== ADMIN_PASSPHRASE) { alert('Incorrect passphrase'); return; }
    adminPanel.style.display = 'block';
    adminToggle.textContent = 'Admin ✱';
    // show status for selected upload day
    const rec = await idbGetVideo(Number(uploadDay.value));
    localInfo.textContent = rec ? `Day ${rec.day} — local: ${rec.filename}` : '— none —';
  } else {
    adminPanel.style.display = 'none';
    adminToggle.textContent = 'Admin';
  }
});

uploadDay.addEventListener('change', async ()=> {
  const rec = await idbGetVideo(Number(uploadDay.value));
  localInfo.textContent = rec ? `Day ${rec.day} — local: ${rec.filename}` : '— none —';
});

uploadBtn.addEventListener('click', async ()=> {
  const f = videoFileInput.files[0];
  if (!f) { alert('Choose a video file to upload'); return; }
  const day = Number(uploadDay.value);
  try{
    await idbPutVideo(day, f, f.name);
    alert('Uploaded to browser storage for Day ' + day + '. Students on this browser will see it.');
    localInfo.textContent = `Day ${day} — local: ${f.name}`;
    if (Number(daySelect.value) === day) loadSelectedDay();
  }catch(e){ alert('Upload failed: ' + e); }
});

clearLocalBtn.addEventListener('click', async ()=> {
  const day = Number(uploadDay.value);
  if (!confirm('Remove local video for Day ' + day + '? This only affects this browser.')) return;
  try{ await idbDeleteVideo(day); alert('Removed local video for Day ' + day); localInfo.textContent = '— none —'; if(Number(daySelect.value)===day) loadSelectedDay(); }catch(e){ alert('Remove failed'); }
});

/* ---------- export & manage tokens ---------- */
exportTokensBtn.addEventListener('click', ()=> {
  try{
    const arr = JSON.parse(localStorage.getItem(tokensKey) || '[]');
    if (!arr.length) { alert('No tokens stored'); return; }
    const rows = ['token,name,email,day,date,time,ts'];
    arr.forEach(r => rows.push([r.token, r.name, r.email, r.day, r.date, r.time, r.ts].map(escapeCsv).join(',')));
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([rows.join('\n')], {type:'text/csv'})); a.download = 'devv_tokens_export.csv'; a.click(); URL.revokeObjectURL(a.href);
  }catch(e){ alert('Export failed'); }
});
wipeTokensBtn.addEventListener('click', ()=> { if(!confirm('Delete all locally stored tokens?')) return; localStorage.removeItem(tokensKey); alert('Local tokens cleared'); });

/* ---------- helpers ---------- */
function showError(msg){ errorEl.textContent = msg; errorEl.style.color = 'var(--danger)'; }
function removeError(){ errorEl.textContent = ''; }
function validateEmail(e){ if(!e) return false; return /^\S+@\S+\.\S+$/.test(e); }
function generateSessionId(){ return Math.random().toString(36).slice(2,12) + Date.now().toString(36).slice(-6); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function escapeCsv(s){ if(s==null) return ''; return '"' + String(s).replace(/"/g,'""') + '"'; }

/* ---------- video error handling ---------- */
video.addEventListener('error', () => {
  showError('Problem loading video. Make sure you replaced ARCHIVE_URLS placeholders or uploaded local videos.');
});

/* ---------- cleanup on unload ---------- */
window.addEventListener('unload', () => { try{ URL.revokeObjectURL(video.src);}catch(e){} });

</script>
</body>
</html>
